@page
@model MallMedia.Presentation.Pages.Admin.Content.CreateModel
@if (Model == null || Model.CurrentUser == null)
{
    <div class="alert alert-danger">
        Error: Model or CurrentUser is null.
    </div>
}
@{
    ViewData["Title"] = "Create Content";
}
<head>
    <!-- Thêm type="module" vào script để hỗ trợ import/export -->
    <script type="module" defer>
        import { checkUserAuthentication } from '/js/auth.js';  // Đảm bảo đường dẫn đúng

        window.onload = async function () {
            try {
                // Gọi hàm checkUserAuthentication và lấy thông tin currentUser
                const currentUser = await checkUserAuthentication();
            } catch (error) {
                console.error('Lỗi khi xác thực:', error);
            }
        };
    </script>
</head>
<div class="container mt-5">
    <h2>Create Content</h2>
    <form id="contentForm" enctype="multipart/form-data">
        <div class="row">
            <!-- Title Input -->
            <div class="form-group pt-3 col-6">
                <label for="title">Title</label>
                <input type="text" id="title" asp-for="Content.Title" class="form-control" />
                <span asp-validation-for="Content.Title" class="text-danger"></span>
            </div>
            <!-- Category Dropdown -->
            <div class="form-group pt-3 col-6">
                <label for="category">Category</label>
                <select id="categoryDropdown" asp-for="Content.CategoryId" class="form-control">
                    <option value="">Select Category</option>
                    @foreach (var category in Model.Categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                </select>
                <span asp-validation-for="Content.CategoryId" class="text-danger"></span>
            </div>

            <!-- Description Input -->
            <div class="form-group pt-3">
                <label for="description">Description</label>
                <textarea id="description" asp-for="Content.Description" rows="4" class="form-control"></textarea>
                <span asp-validation-for="Content.Description" class="text-danger"></span>
            </div>




            <!-- Video Content Upload -->
            <div id="videoContent" class="form-group pt-3 col-6">
                <label for="videoInput">Video Content</label>
                <input type="file" id="videoInput" asp-for="Content.Files" class="form-control" multiple accept="video/mp4" />
                <span id="videoValidation" class="text-danger"></span>
            </div>

            <!-- Created By Field -->
            <div class="form-group col-6 pt-3">
                <label for="currentUser">Created By</label>
                <input type="text" id="userId" asp-for="Content.UserId" readonly hidden value="4395b053-a38e-46d7-afd1-065cbb5fce15" class="form-control" />
                <input type="text" value="Admin" readonly class="form-control" />
            </div>

        </div>

        <!-- Submit Button -->
        <button type="button" class="btn btn-primary mt-4" id="submitBtn">Create Content</button>
    </form>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script>
        const tolerance = 0.01;

        // Helper function to check if value is a multiple of resolution by a specific factor
        function isMultipleOf(value, resolution, factor) {
            const ratio = value / resolution;
            return Math.abs(ratio - factor) < tolerance; // Check if the ratio is close to the desired factor
        }

        // Helper function to check if value is an integer multiple of resolution
        function isIntegerMultiple(value, resolution) {
            const ratio = value / resolution;
            return Math.abs(ratio - Math.round(ratio)) < tolerance; // Check if the ratio is close to an integer
        }

        document.addEventListener('DOMContentLoaded', function () {
            const categoryDropdown = new Choices('#categoryDropdown', {
                searchEnabled: true,
                itemSelectText: '',
                placeholder: true,
                placeholderValue: 'Select Category',
            });
        });

        const chunkSize = 1024 * 1024; // 1MB per chunk
        const uploadEndpoint = '/api/upload-chunked'; // Update with your actual endpoint
        const form = document.getElementById('contentForm');
        const submitBtn = document.getElementById('submitBtn');
        const videoInput = document.getElementById('videoInput');
        const videoValidationMessage = document.getElementById('videoValidation');

        // Function to validate videos
        async function validateVideos(files) {
            const validVideos = [];
            let found1080x1920 = false;
            let found1920x1080 = false;

            for (const file of files) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);

                // Wait for metadata to load to get video dimensions and duration
                await new Promise((resolve) => {
                    video.onloadedmetadata = function () {
                        if (file.type === 'video/mp4' &&
                            file.size <= 200 * 1024 * 1024 &&
                            video.duration >= 25 && video.duration <= 30
                        ) { // Ensure duration is between 25-30 seconds

                            // Extract video metadata (duration and resolution)
                            const metadata = {
                                fileName: file.name,
                                fileType: file.type,
                                fileSize: file.size,
                                duration: video.duration, // Duration in seconds
                                resolution: {
                                    width: video.videoWidth,
                                    height: video.videoHeight
                                }
                            };

                            // Check if the resolution matches either 1920x1080 or 1080x1920
                            if (!found1920x1080 && isIntegerMultiple(video.videoWidth, 1920) && isIntegerMultiple(video.videoHeight, 1080)) {
                                validVideos.push({ file, metadata });
                                found1920x1080 = true;
                            } else if (!found1080x1920 && isIntegerMultiple(video.videoWidth, 1080) && isIntegerMultiple(video.videoHeight, 1920)) {
                                validVideos.push({ file, metadata });
                                found1080x1920 = true;
                            }
                        }
                        resolve();
                    };
                });
            }

            // Final validation message
            if (validVideos.length === 2) {
                videoValidationMessage.textContent = 'Both videos are valid.';
            } else {
                videoValidationMessage.textContent = 'Upload 2 videos in MP4 format with durations between 25-30 seconds, and resolutions 1920x1080 and 1080x1920 (or multiples).';
            }

            return validVideos; // Return valid videos with metadata
        }

        // Chunked upload function
        async function uploadFileInChunks(file, metadata) {
            let start = 0;
            let chunkIndex = 0;
            const totalChunks = Math.ceil(file.size / chunkSize);
            while (start < file.size) {
                const chunk = file.slice(start, start + chunkSize);
                const formData = new FormData();
                formData.append("chunk", chunk);
                formData.append("fileName", file.name);
                formData.append("chunkIndex", chunkIndex);
                formData.append("totalChunks", totalChunks);
                formData.append("metadata", metadata);

                const response = await fetch(uploadEndpoint, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Failed to upload chunk ' + chunkIndex);
                }

                start += chunkSize;
                chunkIndex++;
            }
        }

        // Handle submit button click
        submitBtn.addEventListener('click', async () => {
            const files = videoInput.files;
            const validVideos = await validateVideos(files);
            
            // If validation fails, return
            if (validVideos.length !== 2) {
                return;
            }

            try {
                for (const { file, metadata } of validVideos) {
                    // You now have access to the file and its metadata (duration and resolution)
                    console.log('Video Metadata:', metadata);

                    // Upload file in chunks
                    await uploadFileInChunks(file, metadata);
                }

                // Upload form data
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    alert('Content created successfully!');
                } else {
                    alert('Error creating content.');
                }
            } catch (error) {
                alert('File upload failed: ' + error.message);
            }
        });
    </script>
}
